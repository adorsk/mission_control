
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Jobs &#8212; MissionControl 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Flows" href="flows.html" />
    <link rel="prev" title="User Guide" href="../user_guide.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="flows.html" title="Flows"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../user_guide.html" title="User Guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MissionControl 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../user_guide.html" accesskey="U">User Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="jobs">
<h1>Jobs<a class="headerlink" href="#jobs" title="Permalink to this headline">¶</a></h1>
<div class="section" id="concept-checklist">
<h2>Concept Checklist<a class="headerlink" href="#concept-checklist" title="Permalink to this headline">¶</a></h2>
<p>This page covers these concepts:</p>
<ol class="arabic simple">
<li>[ ] job lifecycle</li>
<li>[ ] job dicts</li>
<li>[ ] building job dirs</li>
<li>[ ] job modules</li>
<li>[ ] running jobs in different environments</li>
<li>[ ] parsing job dirs</li>
<li>[ ] testing job modules</li>
<li>[ ] best practices for working with jobs</li>
</ol>
</div>
<div class="section" id="what-is-a-job">
<h2>What Is a Job?<a class="headerlink" href="#what-is-a-job" title="Permalink to this headline">¶</a></h2>
<p>A MissionControl job represents a standalone computation. For example, a
single run of computational chemistry model.</p>
</div>
<div class="section" id="job-lifecyle">
<h2>Job Lifecyle<a class="headerlink" href="#job-lifecyle" title="Permalink to this headline">¶</a></h2>
<p>In general the lifecycle of a job is like this:</p>
<ol class="arabic">
<li><p class="first">Define a job in terms of an abstract recipe. Example: a dictionary that
specifies a job type and parameters:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s1">&#39;job_type&#39;</span><span class="p">:</span> <span class="s1">&#39;taco&#39;</span><span class="p">,</span>
  <span class="s1">&#39;job_params&#39;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">&#39;wrapper&#39;</span><span class="p">:</span> <span class="s1">&#39;soft_corn&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fillings&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;carne&#39;</span><span class="p">,</span> <span class="s1">&#39;salsa&#39;</span><span class="p">,</span> <span class="s1">&#39;lechuga&#39;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Generate a runnable artifact that executes computations based on the
recipe. Example: a directory that contains inputs and a set of commands:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">taco_job_dir</span><span class="o">/</span>
  <span class="n">inputs</span><span class="o">/</span>
    <span class="n">fillings</span><span class="o">.</span><span class="n">txt</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">txt</span>
  <span class="n">entrypoint</span><span class="o">.</span><span class="n">sh</span>

<span class="o">&lt;</span><span class="n">contents</span> <span class="n">of</span> <span class="n">entrypoint</span><span class="o">.</span><span class="n">sh</span><span class="o">&gt;</span>
<span class="c1">#!/bin/bash</span>
<span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">taco_maker</span> <span class="o">--</span><span class="n">fillings</span><span class="o">=</span><span class="s2">&quot;inputs/fillings.txt&quot;</span> <span class="n">wrapper</span><span class="o">=</span><span class="s2">&quot;inputs/wrapper.txt&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Run the artifact locally or on a computing cluster. Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">slurm</span> <span class="n">sbatch</span> <span class="n">my_taco_job_dir</span><span class="o">/</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</li>
<li><p class="first">Store the executed artifact. Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="n">my_taco_job_dir</span> <span class="n">completed_jobs_archive</span><span class="o">/</span>
</pre></div>
</div>
</li>
<li><p class="first">Parse the executed artifact and store the results in a db. Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">taco_parser</span> <span class="n">completed_jobs_archive</span><span class="o">/</span><span class="n">my_taco_job_dir</span> <span class="o">|</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">taco_client</span> <span class="n">upload</span>
</pre></div>
</div>
</li>
</ol>
<p>MissionControl defines conventions and commands to help people manage the
job lifecycle.</p>
</div>
<div class="section" id="defining-jobs">
<h2>Defining Jobs<a class="headerlink" href="#defining-jobs" title="Permalink to this headline">¶</a></h2>
<p>MissionControl defines jobs as dictionaries with a few primary components:</p>
<dl class="docutils">
<dt>job_type</dt>
<dd><p class="first">A string representing a type of job, typically used to
dispatch to specific handlers during the job lifecyle.</p>
<p class="last">For example, you could specify a job with a job_type of
‘my_modules.my_taco_module’. Then MissionControl tries to build and parse the
job, it would know to use code in a module named ‘my_modules.my_taco_module’.</p>
</dd>
<dt>job_parameters</dt>
<dd><p class="first">A dict of parameters. For example, for our taco job, we could specify
a set of taco parameters, like this:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s1">&#39;wrapper&#39;</span><span class="p">:</span> <span class="s1">&#39;soft_corn&#39;</span><span class="p">,</span>
  <span class="s1">&#39;fillings&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;carne&#39;</span><span class="p">,</span> <span class="s1">&#39;salsa&#39;</span><span class="p">,</span> <span class="s1">&#39;lechuga&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</dd>
<dt>key</dt>
<dd>Often you will also want a key to uniquely identify a job. For example, a
UUID. This key is useful for tracking job statuses, and for avoiding name
collisions when you create and move multiple jobs.</dd>
</dl>
</div>
<div class="section" id="building-jobs">
<h2>Building Jobs<a class="headerlink" href="#building-jobs" title="Permalink to this headline">¶</a></h2>
<p>Now we have a convention for defining jobs in terms of job_dicts. But how do we
build a runnable artifact for a job_dict?</p>
<p>The MissionControl <a class="reference internal" href="../api/mc.utils.job_modules.html#module-mc.utils.job_modules.job_dir_builder" title="mc.utils.job_modules.job_dir_builder"><code class="xref py py-mod docutils literal"><span class="pre">mc.utils.job_modules.job_dir_builder</span></code></a>
module defines a python class that builds a job directory for a given job_dict.</p>
<p>JobDirBuilder builds a directory that contains:</p>
<ol class="arabic simple">
<li>A work_dir that contains scripts and inputs needed to run the job.</li>
<li>An entrypoint script to run the work_dir</li>
<li>job metadata files for tracking the job.</li>
<li>metadata file(s) that specify what resources or environment variables a job
needs to run.</li>
</ol>
<p>We usually don’t interact directly with the JobDirBuilder. Instead we use the
<a class="reference internal" href="houston.html"><span class="doc">Houston</span></a> command runner to call the JobDirBuilder. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mc.houston</span> <span class="k">import</span> <span class="n">Houston</span>
<span class="n">houston</span> <span class="o">=</span> <span class="n">Houston</span><span class="o">.</span><span class="n">minimal</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="n">scratch_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="n">job_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">scratch_dir</span><span class="p">,</span> <span class="s1">&#39;my_job_dir&#39;</span><span class="p">)</span>
<span class="n">build_result</span> <span class="o">=</span> <span class="n">houston</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
   <span class="s1">&#39;build_job_dir&#39;</span><span class="p">,</span>
   <span class="n">job_dict</span><span class="o">=</span><span class="p">{</span>
       <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;my_job_key&#39;</span><span class="p">,</span>
       <span class="s1">&#39;job_type&#39;</span><span class="p">:</span> <span class="s1">&#39;mc.utils.testing.echo_job_module&#39;</span><span class="p">,</span>
       <span class="s1">&#39;job_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Tacos are delicious.&#39;</span><span class="p">},</span>
   <span class="p">},</span>
   <span class="n">output_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">job_dir_path</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">built_job_dir</span> <span class="o">=</span> <span class="n">build_result</span><span class="p">[</span><span class="s1">&#39;job_dir&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">built_job_dir</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code creates a Houston instance, and then runs the command
‘build_job_dir’. The output of the above example is the path to a job dir:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>my_job_dir
</pre></div>
</div>
<p>Let’s look at the contents of the job_dir:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">job_dir_items</span> <span class="o">=</span> <span class="p">[</span>
   <span class="nb">str</span><span class="p">(</span><span class="n">item_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">job_dir_path</span><span class="p">))</span>
   <span class="k">for</span> <span class="n">item_path</span> <span class="ow">in</span> <span class="n">job_dir_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**/*&#39;</span><span class="p">)</span>
<span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">job_dir_items</span><span class="p">)))</span>
</pre></div>
</div>
<p>Expected output:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>JOBMAN__JOB_SPEC.json
MC__JOB_KEY
MC__JOB_META.json
entrypoint.sh
work_dir
work_dir/entrypoint.sh
</pre></div>
</div>
<p>We see a list of metadata files and the work_dir .</p>
</div>
<div class="section" id="job-modules">
<h2>Job Modules<a class="headerlink" href="#job-modules" title="Permalink to this headline">¶</a></h2>
<p>How did MissionControl know how to build the job dir in the example abeove?
The key is the ‘job_type’ component of the job_dict.</p>
<p>Here is what happend:</p>
<p>#. In our job_dict we specified a job_type of
‘mc.utils.test.echo_job_module’.</p>
<ol class="arabic simple">
<li>When we ran the ‘build_job_dir’ command, MissionControl looked at the
job_type component, and saw that it should try to dispatch to a module named
‘mc.utils.testing.echo_job_module’. This module is a small utility module
that is included in MissionControl: <a class="reference internal" href="../api/mc.utils.testing.html#module-mc.utils.testing.echo_job_module" title="mc.utils.testing.echo_job_module"><code class="xref py py-mod docutils literal"><span class="pre">mc.utils.testing.echo_job_module</span></code></a> .
It contains a function <a class="reference internal" href="../api/mc.utils.testing.html#mc.utils.testing.echo_job_module.build_work_dir" title="mc.utils.testing.echo_job_module.build_work_dir"><code class="xref py py-mod docutils literal"><span class="pre">mc.utils.testing.echo_job_module.build_work_dir</span></code></a>
which defines how to build a work_dir.</li>
<li>By convention, MissionControl loaded a function named ‘build_work_dir’
in the python module that has the same name as the job_type. This function
received the job_params and an output_dir as kwargs.</li>
<li>MissionControl executed the ‘build_work_dir’ function</li>
<li>The ‘build_work_dir’ function created the job directory.</li>
</ol>
<p>You can also specify a specific builder when you call the ‘build_job_dir’
command. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_build_work_dir</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">entrypoint_name</span> <span class="o">=</span> <span class="s1">&#39;entrypoint.sh&#39;</span>
    <span class="kn">import</span> <span class="nn">textwrap</span>
    <span class="n">entrypoint_content</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        #!/bin/bash</span>
<span class="sd">        echo &quot;from my_work_dir_builder&quot;</span>
<span class="sd">        echo {message}</span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])</span>
    <span class="n">entrypoint_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">entrypoint_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">entrypoint_path</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">entrypoint_content</span><span class="p">)</span>
    <span class="n">entrypoint_path</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="mh">0x775</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;dir&#39;</span><span class="p">:</span> <span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;entrypoint_name&#39;</span><span class="p">:</span> <span class="n">entrypoint_name</span><span class="p">}</span>

<span class="n">build_result</span> <span class="o">=</span> <span class="n">houston</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
   <span class="s1">&#39;build_job_dir&#39;</span><span class="p">,</span>
   <span class="n">job_dict</span><span class="o">=</span><span class="p">{</span>
       <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;my_job_key&#39;</span><span class="p">,</span>
       <span class="s1">&#39;job_type&#39;</span><span class="p">:</span> <span class="s1">&#39;mc.utils.testing.echo_job_module&#39;</span><span class="p">,</span>
       <span class="s1">&#39;job_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Tacos are delicious.&#39;</span><span class="p">},</span>
   <span class="p">},</span>
   <span class="n">build_work_dir_fn</span><span class="o">=</span><span class="n">my_build_work_dir</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="running-jobs">
<h2>Running Jobs<a class="headerlink" href="#running-jobs" title="Permalink to this headline">¶</a></h2>
<p>Once you have built a job how can you run it?</p>
<p>There are several ways to run a job. We outline a few here.</p>
<div class="section" id="strategy-a-run-locally">
<h3>Strategy A: Run Locally<a class="headerlink" href="#strategy-a-run-locally" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>In this strategy, you simply execute bash commands to execute a job. Example:</dt>
<dd><div class="first last highlight-default"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">my_job_dir</span><span class="o">/</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</dd>
</dl>
<div class="section" id="pros">
<h4>Pros<a class="headerlink" href="#pros" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>This is the simplest strategy. It requires no coordination with external
systems.</li>
</ol>
</div>
<div class="section" id="cons">
<h4>Cons<a class="headerlink" href="#cons" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Your jobs are limited by the resources of your local environment. This may
make it difficult to run large numbers of jobs, or to run jobs that require
lots of CPUs or special software.</li>
</ol>
</div>
</div>
<div class="section" id="strategy-b-run-on-an-external-computation-resource">
<h3>Strategy B: Run on an External Computation Resource<a class="headerlink" href="#strategy-b-run-on-an-external-computation-resource" title="Permalink to this headline">¶</a></h3>
<p>In this strategy, you submit jobs directly to an external resource, such as
a computing cluster, or an EC2 instance. Example:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">my_job_dir</span> <span class="n">me</span><span class="nd">@cluster_x</span><span class="p">:</span><span class="n">my_jobs</span>
<span class="n">ssh</span> <span class="n">me</span><span class="nd">@cluster_x</span> <span class="s1">&#39;cd my_jobs/my_job_dir &amp;&amp; sbatch entrypoint.sh&#39;</span>
</pre></div>
</div>
</div></blockquote>
<div class="section" id="id1">
<h4>Pros<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>You can take advantage of cluster nodes to run large numbers of jobs.</li>
<li>You can use special hardware and software provided by a cluster.</li>
</ol>
</div>
<div class="section" id="id2">
<h4>Cons<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>You need to coordinate submissions with an external resource.</li>
<li>You need to monitor job progress.</li>
<li>It can take time to transfer job files to and from the external resource.</li>
</ol>
</div>
</div>
<div class="section" id="strategy-c-submit-to-a-meta-scheduler">
<h3>Strategy C: Submit to a meta-scheduler<a class="headerlink" href="#strategy-c-submit-to-a-meta-scheduler" title="Permalink to this headline">¶</a></h3>
<p>In this strategy, you submit jobs directly to a meta-scheduler, such as
<cite>jobman.</cite> The meta-scheduler runs jobs locally or submits them to external
resources, depending on what resources are available. The meta-scheduler can
also create batches of jobs and optimize file transfers.</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">jobman</span><span class="o">.</span><span class="n">cli</span> <span class="n">submit_job_dir</span> <span class="n">my_job_dir</span>
</pre></div>
</div>
</div></blockquote>
<div class="section" id="id3">
<h4>Pros<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>You can use simultaneously use multiple clusters.</li>
<li>You only have to coordinate with the meta-scheduler, as opposed to
coordinating with several different clusters.</li>
<li>You can run jobs more efficiently if the meta-scheduler can make batches
of jobs.</li>
</ol>
</div>
<div class="section" id="id4">
<h4>Cons<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>You need to coordinate with the meta-scheduler.</li>
<li>You need to configure the meta-scheduler.</li>
</ol>
</div>
</div>
<div class="section" id="which-strategy-to-choose">
<h3>Which Strategy To Choose?<a class="headerlink" href="#which-strategy-to-choose" title="Permalink to this headline">¶</a></h3>
<p>It depends. In general, choose whichever strategy is easiest to get started
with first.</p>
</div>
</div>
<div class="section" id="configuring-how-jobs-run">
<h2>Configuring How Jobs Run<a class="headerlink" href="#configuring-how-jobs-run" title="Permalink to this headline">¶</a></h2>
<p>Often we want to specify how jobs should run. Common run parameters include:</p>
<ol class="arabic simple">
<li>How much memory should be allocated for a job?</li>
<li>How many cores can a job use?</li>
<li>Can a job be batched with other jobs?</li>
<li>Which specific executables should a job use?</li>
</ol>
<p>These parameters are different from job parameters. Job parameters
specify what a job should run (‘run model X for three iterations’). Whereas
run parameters specify how a job should run (‘run the job using 4 cores’).</p>
<p>MissionControl has a convention for specifying run parameters. When
MissionControl builds a job dir, it outputs a ‘run_params’ metadata file.
This metadata file is a generic JSON file. Various job runners can read this
file and then translate the given run parameters into parameters specific to a
given run environment.</p>
<p>For example, a job runner that runs job dirs in a Slurm environment can
translate parameters for memory and cores into Slurm-specific parameters.</p>
<p>By default MissionControl generates a run_params file that is compatible with
the <cite>Jobman</cite> meta-scheduler.</p>
<div class="section" id="environment-specific-configurations">
<h3>Environment-Specific Configurations<a class="headerlink" href="#environment-specific-configurations" title="Permalink to this headline">¶</a></h3>
<p>Let’s think about our echo job from the examples above. It is simple and should
run the same in any environment.</p>
<p>But what if want to run jobs that need special configurations. What if these
configurations depend on the environment the job runs in?</p>
<p>For example, what if we want to run job that requires a specific version of a
quantum chemistry library? What if we want to run this job on two different
clusters, cluster X and cluster Y?</p>
<p>There are a few strategies we can use to define environment-specific
configurations.</p>
<div class="section" id="strategy-a-builder-per-environment">
<h4>Strategy A: Builder Per Environment<a class="headerlink" href="#strategy-a-builder-per-environment" title="Permalink to this headline">¶</a></h4>
<p>In this strategy, we write a builder for each environment in which we expect to
run our job.</p>
<dl class="docutils">
<dt>For example, our code might look something like this:</dt>
<dd><div class="first last highlight-default"><div class="highlight"><pre><span></span><span class="c1"># &lt;chem_builder_a.py&gt;</span>
<span class="k">def</span> <span class="nf">build_work_dir_for_cluster_x</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
  <span class="c1"># define configs for cluster X</span>
  <span class="n">chem_lib_executable</span> <span class="o">=</span> <span class="s1">&#39;/cluster/x/software/my_chem_lib-1.0.1&#39;</span>
  <span class="n">entrypoint</span> <span class="o">=</span> <span class="n">_write_entrypoint</span><span class="p">(</span><span class="n">chem_lib_executable</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;entrypoint&#39;</span><span class="p">:</span> <span class="n">entrypoint</span><span class="p">}</span>
  <span class="o">...</span>

<span class="k">def</span> <span class="nf">build_work_dir_cluster_x</span><span class="p">(</span><span class="o">...</span><span class="p">):</span> <span class="o">...</span>
  <span class="n">chem_lib_executable</span> <span class="o">=</span> <span class="s1">&#39;/cluster/y/bin/my_chem_lib-1.0.1&#39;</span>
  <span class="n">entrypoint</span> <span class="o">=</span> <span class="n">_write_entrypoint</span><span class="p">(</span><span class="n">chem_lib_executable</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;entrypoint&#39;</span><span class="p">:</span> <span class="n">entrypoint</span><span class="p">}</span>
  <span class="o">...</span>

<span class="k">def</span> <span class="nf">write_entrypoint</span><span class="p">(</span><span class="n">chem_lib_executable</span><span class="p">):</span>
    <span class="n">entrypoint_content</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      #!/bin/bash</span>
<span class="sd">      CHEM_LIB_EXE=&quot;{chem_lib_executable}&quot;</span>
<span class="sd">      $CHEM_LIB_EXE my_chem_command</span>
<span class="sd">      &#39;&#39;&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chem_lib_executable</span><span class="o">=</span><span class="n">chem_lib_excutable</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</dd>
</dl>
<p>And then when we build our job directories, we just specify which builder to
use:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">my_chem_builder_a</span>
<span class="c1"># for cluster x</span>
<span class="n">houston</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
  <span class="s1">&#39;build_job_dir&#39;</span><span class="p">,</span>
  <span class="n">job_dict</span><span class="o">=</span><span class="p">{</span><span class="o">...</span><span class="p">},</span>
  <span class="n">build_work_dir_fn</span><span class="o">=</span><span class="n">my_chem_builder_a</span><span class="o">.</span><span class="n">build_work_dir_for_cluster_x</span>
<span class="p">)</span>

<span class="c1"># for cluster y</span>
<span class="n">houston</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
  <span class="s1">&#39;build_job_dir&#39;</span><span class="p">,</span>
  <span class="n">job_dict</span><span class="o">=</span><span class="p">{</span><span class="o">...</span><span class="p">},</span>
  <span class="n">build_work_dir_fn</span><span class="o">=</span><span class="n">my_chem_builder_a</span><span class="o">.</span><span class="n">build_work_dir_for_cluster_y</span>
<span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<div class="section" id="id5">
<h5>Pros<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>It’s often easier for new users of our code to add new code. “I just copy
from the previous example!”</li>
</ol>
</div>
<div class="section" id="id6">
<h5>Cons<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h5>
<ol class="arabic">
<li><p class="first">Maximizing Cluster Use:
#. We have to know where our job will run at the time we build it. This</p>
<blockquote>
<div><p>means we would have to check cluster availability at job build time,
rather than at job run time.</p>
</div></blockquote>
<ol class="arabic simple">
<li>We can’t make batches of heterogenous jobs ahead of run time, because
we would have to check that all the jobs have been built for the same
cluster.</li>
</ol>
</li>
<li><p class="first">Maintenance:
#. If our ‘_generate_common_content’ function signature changes,</p>
<blockquote>
<div><p>we will have to find all the places where is called.</p>
</div></blockquote>
<ol class="arabic simple">
<li>If another type of job uses the same chemstry library, we will have to
repeat our configurations in the builder for that type of job.</li>
</ol>
</li>
<li><p class="first">Testing: we have to test each of our builders.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="strategy-b-one-builder-config-spec">
<h4>Strategy B: One Builder + Config Spec<a class="headerlink" href="#strategy-b-one-builder-config-spec" title="Permalink to this headline">¶</a></h4>
<p>Another strategy is to define one builder, and output a ‘config spec’ along
with the job_dir. The config spec describes what things this job needs to run.</p>
<dl class="docutils">
<dt>For example:</dt>
<dd><div class="first last highlight-default"><div class="highlight"><pre><span></span><span class="c1"># &lt;my_chem_builder_b.py&gt;</span>
<span class="k">def</span> <span class="nf">build_work_dir</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="c1"># define config spec</span>
    <span class="n">config_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;chem_lib_executable&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;env_var&#39;</span><span class="p">:</span> <span class="s1">&#39;CHEM_LIB_EXE&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;entrypoint&#39;</span><span class="p">:</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="s1">&#39;config_spec&#39;</span><span class="p">:</span> <span class="n">config_spec</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">write_entrypoint</span><span class="p">():</span>
    <span class="n">entrypoint_content</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      #!/bin/bash</span>
<span class="sd">      $CHEM_LIB_EXE my_chem_command</span>
<span class="sd">      &#39;&#39;&#39;</span>
    <span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</dd>
</dl>
<div class="section" id="id7">
<h5>Pros<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Maintenance: all our logic is one place, so it’s easier to maintain.</li>
<li>We don’t have to know where our job will be run when we build it. So we could
send it to any cluster that has available resources. And we can batch
together any collection of jobs.</li>
<li>Testing: we only have one builder to test.</li>
</ol>
</div>
<div class="section" id="id8">
<h5>Cons<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Whatever runs our job now bears the responsibility for fulfilling the config
spec requirements.</li>
<li>It can be harder for novice users to understand how configs get set.</li>
</ol>
</div>
</div>
<div class="section" id="a-vs-b-which-one-to-choose">
<h4>A vs. B: Which One to Choose?<a class="headerlink" href="#a-vs-b-which-one-to-choose" title="Permalink to this headline">¶</a></h4>
<p>In general, the MissionControl authors recommend strategy B. The advantages in
testing and cluster use make up for the slightly higher barrier-to-entry for
job module writers.</p>
</div>
</div>
</div>
<div class="section" id="parsing-job-dirs">
<h2>Parsing Job Dirs<a class="headerlink" href="#parsing-job-dirs" title="Permalink to this headline">¶</a></h2>
<p>Often we want to extract data from executed job dirs.</p>
<p>The MissionControl <a class="reference internal" href="../api/mc.utils.job_modules.html#module-mc.utils.job_modules.job_dir_parser" title="mc.utils.job_modules.job_dir_parser"><code class="xref py py-mod docutils literal"><span class="pre">mc.utils.job_modules.job_dir_parser</span></code></a> module
defines a python class that helps us parses a given job directory.</p>
<p>Typically we don’t interact directly with the JobDirParser. Instead we use the
<a class="reference internal" href="houston.html"><span class="doc">Houston</span></a> command runner to call the JobDirParser. For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mc.houston</span> <span class="k">import</span> <span class="n">Houston</span>
<span class="n">houston</span> <span class="o">=</span> <span class="n">Houston</span><span class="o">.</span><span class="n">minimal</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="n">scratch_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="n">job_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">scratch_dir</span><span class="p">,</span> <span class="s1">&#39;my_job_dir&#39;</span><span class="p">)</span>
<span class="n">build_result</span> <span class="o">=</span> <span class="n">houston</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
   <span class="s1">&#39;build_job_dir&#39;</span><span class="p">,</span>
   <span class="n">job_dict</span><span class="o">=</span><span class="p">{</span>
       <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;my_job_key&#39;</span><span class="p">,</span>
       <span class="s1">&#39;job_type&#39;</span><span class="p">:</span> <span class="s1">&#39;mc.utils.testing.echo_job_module&#39;</span><span class="p">,</span>
       <span class="s1">&#39;job_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Tacos are delicious.&#39;</span><span class="p">},</span>
   <span class="p">},</span>
   <span class="n">output_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">job_dir_path</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">built_job_dir</span> <span class="o">=</span> <span class="n">build_result</span><span class="p">[</span><span class="s1">&#39;job_dir&#39;</span><span class="p">]</span>

<span class="c1"># Here we execute a &#39;fake&#39; run, using prebaked output.</span>
<span class="c1"># This often a useful strategy for testing parsers.</span>
<span class="n">houston</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
   <span class="s1">&#39;run_job_dir&#39;</span><span class="p">,</span>
   <span class="n">job_dir</span><span class="o">=</span><span class="n">built_job_dir</span><span class="p">,</span>
   <span class="n">fake</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">parse_results</span> <span class="o">=</span> <span class="n">houston</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
   <span class="s1">&#39;parse_job_dir&#39;</span><span class="p">,</span>
   <span class="n">job_dir</span><span class="o">=</span><span class="n">built_job_dir</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">parse_results</span><span class="p">)</span>
</pre></div>
</div>
<p>Expected output:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>{&#39;output&#39;: &#39;Tacos are delicious.\n&#39;}
</pre></div>
</div>
<div class="section" id="parser-outputs">
<h3>Parser Outputs<a class="headerlink" href="#parser-outputs" title="Permalink to this headline">¶</a></h3>
<p>What should a parser return as outputs? It depends.</p>
<p>MissionControl has no requirements on what a parser must return.</p>
<p>Often what you want a parser to return is some set of update specs that you can
pass to a database client, in order to update records in a database.</p>
<dl class="docutils">
<dt>The MissionControl <cite>EntityDb</cite> can help you with this type of parsing. See</dt>
<dd><cite>examples.entity_db_parse_and_load</cite>.</dd>
</dl>
</div>
</div>
<div class="section" id="testing-job-modules">
<h2>Testing Job Modules<a class="headerlink" href="#testing-job-modules" title="Permalink to this headline">¶</a></h2>
<p>The MissionControl authors strongly recommend writing tests for your job module
functions, for several reasons:</p>
<ol class="arabic simple">
<li>Debugging is easier in the context of small, isolated tests. Debugging is
much harder when you have many jobs running in different environments.</li>
<li>Tests act as a form of documentation for your code.</li>
<li>Tests let you change your code with confidence.</li>
</ol>
<p>For examples of how to test job module functions, see the source of
<code class="xref py py-mod docutils literal"><span class="pre">mc.utils.testing.tests.test_echo_job_module</span></code>.</p>
<div class="section" id="including-prebaked-outputs">
<h3>Including Prebaked Outputs<a class="headerlink" href="#including-prebaked-outputs" title="Permalink to this headline">¶</a></h3>
<p>Something that is often helpful for testing jobs is including prebaked outputs
with your job module code. Example: including the output file of a long-running
computational chemistry model alongside your job module code.</p>
<p>Prebaked outputs are helpful for several reasons:</p>
<ol class="arabic simple">
<li>prebaked outputs can help with testing parsers.</li>
<li>prebaked outputs make it easier to test your jobs in the context of flows
and pipelines.</li>
</ol>
<p>For an example of one way to include prebaked outputs, see the source of
<a class="reference internal" href="../api/mc.utils.testing.html#module-mc.utils.testing.echo_job_module" title="mc.utils.testing.echo_job_module"><code class="xref py py-mod docutils literal"><span class="pre">mc.utils.testing.echo_job_module</span></code></a>.</p>
</div>
</div>
<div class="section" id="recommended-practices-for-working-with-jobs">
<h2>Recommended Practices for Working with Jobs<a class="headerlink" href="#recommended-practices-for-working-with-jobs" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Write small functions in your modules.</p>
<p>This will make your job modules easier to test and understand.</p>
</li>
<li><p class="first">Use constants.py files in your modules.</p>
<p>If your parsers and builders need to refer to common paths or settings, put
the settings in a constants.py module that both your parsers and builders
can access. Then, if you need to change these settings, you only need to
change them in one place.</p>
</li>
<li><p class="first">Write tests for your job modules.</p>
</li>
<li><p class="first">Define a runner with prebaked outputs.</p>
<p>This will make your job modules easier to test, both individually and in
the context of flows.</p>
</li>
<li><p class="first">Use the ‘One Builder + Config Spec’ strategy to specify requirements that
vary across environments.</p>
</li>
<li><p class="first">Write tests for your job modules.</p>
</li>
</ol>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Jobs</a><ul>
<li><a class="reference internal" href="#concept-checklist">Concept Checklist</a></li>
<li><a class="reference internal" href="#what-is-a-job">What Is a Job?</a></li>
<li><a class="reference internal" href="#job-lifecyle">Job Lifecyle</a></li>
<li><a class="reference internal" href="#defining-jobs">Defining Jobs</a></li>
<li><a class="reference internal" href="#building-jobs">Building Jobs</a></li>
<li><a class="reference internal" href="#job-modules">Job Modules</a></li>
<li><a class="reference internal" href="#running-jobs">Running Jobs</a><ul>
<li><a class="reference internal" href="#strategy-a-run-locally">Strategy A: Run Locally</a><ul>
<li><a class="reference internal" href="#pros">Pros</a></li>
<li><a class="reference internal" href="#cons">Cons</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strategy-b-run-on-an-external-computation-resource">Strategy B: Run on an External Computation Resource</a><ul>
<li><a class="reference internal" href="#id1">Pros</a></li>
<li><a class="reference internal" href="#id2">Cons</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strategy-c-submit-to-a-meta-scheduler">Strategy C: Submit to a meta-scheduler</a><ul>
<li><a class="reference internal" href="#id3">Pros</a></li>
<li><a class="reference internal" href="#id4">Cons</a></li>
</ul>
</li>
<li><a class="reference internal" href="#which-strategy-to-choose">Which Strategy To Choose?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuring-how-jobs-run">Configuring How Jobs Run</a><ul>
<li><a class="reference internal" href="#environment-specific-configurations">Environment-Specific Configurations</a><ul>
<li><a class="reference internal" href="#strategy-a-builder-per-environment">Strategy A: Builder Per Environment</a><ul>
<li><a class="reference internal" href="#id5">Pros</a></li>
<li><a class="reference internal" href="#id6">Cons</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strategy-b-one-builder-config-spec">Strategy B: One Builder + Config Spec</a><ul>
<li><a class="reference internal" href="#id7">Pros</a></li>
<li><a class="reference internal" href="#id8">Cons</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-vs-b-which-one-to-choose">A vs. B: Which One to Choose?</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#parsing-job-dirs">Parsing Job Dirs</a><ul>
<li><a class="reference internal" href="#parser-outputs">Parser Outputs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-job-modules">Testing Job Modules</a><ul>
<li><a class="reference internal" href="#including-prebaked-outputs">Including Prebaked Outputs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#recommended-practices-for-working-with-jobs">Recommended Practices for Working with Jobs</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../user_guide.html"
                        title="previous chapter">User Guide</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="flows.html"
                        title="next chapter">Flows</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/user_guide/jobs.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="flows.html" title="Flows"
             >next</a> |</li>
        <li class="right" >
          <a href="../user_guide.html" title="User Guide"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MissionControl 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../user_guide.html" >User Guide</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, A. Dorsk.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.2.
    </div>
  </body>
</html>